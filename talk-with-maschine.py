#!/usr/bin/env python

import hidapi
import binascii
import time

hidapi.hid_init()
    
print 'Loaded hidapi library from: {:s}\n'.format(hidapi.hid_lib_path())

devices = hidapi.hid_enumerate(0x17cc, 0x1140)
if len(devices) == 0:
    print "No maschine attached"
    exit(1)

device = hidapi.hid_open(0x17cc, 0x1140)

quiet_state = "20000000100020003000400050006000700080009000a000b000c000d000e000f0000000100020003000400050006000700080009000a000b000c000d000e000f0"

to_bytearray = lambda display: [bytearray(line.replace(" ", "").decode("hex")) for line in display]
write_display = lambda display: [hidapi.hid_write(device, line) for line in to_bytearray(display)]

def clear_display(no):
    for i in range(0, 8):
        hidapi.hid_write(device, (bytearray((("e00000%02x00200008" % (8 * i) + ((265 - 8) * "00")).replace("e0", "e%d" %no)).decode("hex"))))

led_state = bytearray("820a0a0a 0a0a0a0a 0a0a0a0a 0a0a0a0a 0a0a0a0a 0a0a0a0a 0a3f3f3f 3f3f3f3f".replace(" ", "").decode("hex"))
hidapi.hid_write(device, led_state)

def import_image(display_no, fname):
    import textwrap
    result_str = open(fname, "r").read()
    result_bytes = textwrap.wrap(result_str, 2)
    # reverse bits of each byte
    result_bytes = ''.join(['%02x' % int('{0:08b}'.format(int(n, 16))[::-1], 2) for n in result_bytes])
    print result_bytes
    result_lines = textwrap.wrap(result_bytes, 512)
    result = []
    for i in range(0,8):
        result.append("e%01x0000%02x0020000800%s" % (display_no, i * 8, result_lines[i]))
    return result

tux = import_image(0, "tux.hex")
test = import_image(1, "test.hex")

machinelogo = [
    "e0000000002000080080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "e0000008002000080080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "e0000010002000080080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007e00000000000000000000000000000000000000000000000000000000000003ffc000000000000000000000000000000000000000000000000000000000000fe7f000000000000000000000000000000000000000000000000000000000001e0078003f800fe003f0003ff8001ff007e00fc3e0f801f0ffff00000000000038001c003f800fe007f800fffe003ffc07e00fc3e0fc01f0ffff000000000000707e0e003fc01fe007f801ffff00fffe07e00fc3e0fe01f0ffff000000",
    "e00000180020000800800000e1ff87003fc01fe00ffc03ffff81ffff07e00fc3e0fe01f0ffff000000000000c3ffc3003fe03fe00ffc07f83f83ffff87e00fc3e0ff01f0ffff000000000001c7ffe3803fe03fe00ffc07e01fc3f81f87e00fc3e0ff81f0f8000000000000018f00f1803fe03fe01ffe07e00007e00fc7e00fc3e0ffc1f0f8000000000000038e0071c03ff07fe01ffe07f80007c007c7e00fc3e0ffc1f0f8000000000000039e0079c03ff07fe03f3f07ffe007c00007ffffc3e0ffe1f0f8000000000000039e0079c03ff8ffe03f3f03fffc0fc00007ffffc3e0fff1f0fffe0000000000031e0078c03ff8ffe03e1f01ffff0f800007ffffc3e0fbf9f0fffe000000",
    "e000002000200008008000031e0078c03efdfbe07e1f807fff8f800007ffffc3e0fbf9f0fffe0000000000039e0079c03efdfbe07e1f800fffcfc00007ffffc3e0f9fdf0fffe0000000000039e0079c03e7ff3e0ffffc0003fc7c007c7e00fc3e0f8fff0f8000000000000038e0071c03e7ff3e0ffffc0000fc7c007c7e00fc3e0f87ff0f8000000000000018f00f1803e3fe3e0ffffc00007c7e00fc7e00fc3e0f83ff0f800000000000001c7ffe3803e3fe3e1ffffe7f00fc3f81f87e00fc3e0f83ff0f800000000000000c3ffc3003e3fe3e1ffffe3fc1fc3ffff87e00fc3e0f81ff0ffff000000000000e1ff87003e1fc3e3f003f3ffff81ffff07e00fc3e0f80ff0ffff000000",
    "e00000280020000800800000707e0e003e1fc3e3f003f1ffff80fffe07e00fc3e0f807f0ffff00000000000038001c003e0f83e3e001f07fff007ffc07e00fc3e0f807f0ffff0000000000001e0078003e0f83e7e001f81ffc001ff007e00fc3e0f803f0ffff0000000000000fe7f0000000000000000000000000000000000000000000000000000000000003ffc0000000000000000000000000000000000000000000000000000000000000ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "e0000030002000080080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "e0000038002000080080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
]

machineicon = [
    "e10000000020000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003fffffffffffffc000000000000000000000000000000000000000000000000",
    "e1000008002000080003fffffffffffffc00000000000000000000000000000000000000000000000003fffffffffffffc00000000000000000000000000000000000000000000000003fffffffffffffc00000000000000000000000000000000000000000000000003c4718c6318c63c00000000000000000000000000000000000000000000000003c4718c6318c63c00000000000000000000000000000000000000000000000003fffffffffffffc00000000000000000000000000000000000000000000000003fffffffffffffc00000000000000000000000000000000000000000000000003c470000300003c000000000000000000000000000000000000000000000000",
    "e1000010002000080003c470000300003c00000000000000000000000000000000000000000000000003c470000300003c00000000000000000000000000000000000000000000000003fff0000300003c00000000000000000000000000000000000000000000000003c470000300003c00000000000000000000000000000000000000000000000003c470000300003c00000000000000000000000000000000000000000000000003c470000300003c000f3f3cf9f8633c78f336cdf078f3efdb679f3e0f3e000003fffffffffffffc00198c66cc607766cd9b36cd80cd9b031b6cd9b019b3000003fffffffffffffc00180c66cc607f66c18336ed80c19b031b6cd9b019b30000",
    "e1000018002000080003fffffffffffffc000f0c7ef8606b7e7983f6fde0799bc31b6fdf3c19be000003c47bdef7bdef7c00018c66f06063660d8336dd800d9b031b6cde3019bc000003c4718c6318c63c00198c66d8606366cd9b36cd80cd9b031b6cdb3019b6000003fffbdef7bdef7c000f0c66cc60636678f336cdf078f3030fccd9be0f33000003fffffffffffffc00000000000000000000000000000000000000000000000003fffffffffffffc00000000000000000000000000000000000000000000000003c73878e082083c00000000000000000000000000000000000000000000000003c61878e082083c000000000000000000000000000000000000000000000000",
    "e1000020002000080003fe187fe082083c00000000000000000000000000000000000000000000000003c73ff8e082083c00000000000000000000000000000000000000000000000003c7fff8e082083c00000000000000000000000000000000000000000000000003fffffffffffffc00000000000000000000000000000000000000000000000003c44478e082083c00000000000000000000000000000000000000000000000003c44478e082083c001f3e7cf1e0799b7df803c799bf7c7980f9e7c18dbe600003ffffffe082083c0019b3619b30cd9b6060c66cd98c66cd80c33661ddb3600003fffff8e082083c0019b3618300c19b6060c60cdd8c66cd80c33661fdb36000",
    "e1000028002000080003c44478e082083c001f3e78f1e079fb7863f60cdf8c7ccd80f337c1adb3600003c4447ffffffffc00183c6018300d9b6060c60cdb8c78cd80c337818db3600003fffff8e082083c001836619b30cd9b6060c66cd98c6ccd80c336c18db3600003c44478e082083c0018337cf1e0799b606003c7998c6679f0c1e6618dbe600003c4447fe082083c00000000000000000000000000000000000000000000000003fffff8e082083c00000000000000000000000000000000000000000000000003fffff8e082083c00000000000000000000000000000000000000000000000003fffffffffffffc000000000000000000000000000000000000000000000000",
    "e1000030002000080003c44478e082083c00000000000000000000000000000000000000000000000003c44478e082083c00000000000000000000000000000000000000000000000003ffffffe082083c00000000000000000000000000000000000000000000000003c44478e082083c00000000000000000000000000000000000000000000000003c44478e082083c00000000000000000000000000000000000000000000000003fffffffffffffc00000000000000000000000000000000000000000000000003fffffffffffffc00000000000000000000000000000000000000000000000003fffffffffffffc000000000000000000000000000000000000000000000000",
    "e1000038002000080003fffffffffffffc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
]

clear_display(0)
time.sleep(1)
clear_display(1)
time.sleep(1)
write_display(tux)
time.sleep(1)
write_display(machineicon)

count = 0

import random
while True:
    count += 1
    if count == 100:
        led_state = bytearray(("82" + ''.join(format(random.randint(0,255), '02x') for _ in range(31))).decode("hex"))
        hidapi.hid_write(device, led_state)

        # 16 rgb buttons
        pad_state = bytearray(("80" + ''.join(format(random.randint(0,255), '02x') for _ in range(16 * 3))).decode("hex"))
        hidapi.hid_write(device, pad_state)

        # 8 group rgb_1 + 8 group rgb_2 + 8 transport buttons
        group_other_btn_state = bytearray(("81" + ''.join(format(random.randint(0,255), '02x') for _ in range(((8 + 8) * 3) + 8))).decode("hex"))
        hidapi.hid_write(device, group_other_btn_state)

        count = 0

    result = hidapi.hid_read(device, 256)
    state = binascii.hexlify(result)
    if state != quiet_state:
        print "#%d: %s"  % (len(result), state)

hidapi.hid_close(device)
